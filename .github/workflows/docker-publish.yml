name: Wings

on:
  workflow_dispatch:

permissions:
  actions: write
  contents: write

concurrency:
  group: wings
  cancel-in-progress: true

jobs:
  wings:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install Docker Compose
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version

      - name: Download latest Wings backup
        continue-on-error: true
        uses: robinraju/release-downloader@v1.11
        with:
          tag: wings-backups
          fileName: "wings-backup.tar.gz.part*"
          out-file-path: "."

      - name: Restore backup (if exists)
        run: |
          sudo mkdir -p ks/wings

          PARTS=($(ls wings-backup.tar.gz.part* 2>/dev/null || true))
          if [ ${#PARTS[@]} -gt 0 ]; then
            echo "üîÑ Found split backup parts"
            cat wings-backup.tar.gz.part* > merged.tar.gz
            sudo rm -rf ks/wings/data
            sudo tar -xzf merged.tar.gz -C ks/wings
            echo "‚úÖ Backup restored"
          else
            echo "‚ö†Ô∏è No backup found ‚Äî creating fresh directory"
            sudo mkdir -p ks/wings/data
          fi

      - name: Install Cloudflare Tunnel
        run: |
          sudo curl -L "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64" -o /usr/local/bin/cloudflared
          sudo chmod +x /usr/local/bin/cloudflared
          sudo cloudflared service install YOUR_TOKEN_HERE

      - name: Start Wings
        run: |
          cd ks/wings
          sudo rm -f docker-compose.yml || true
          cat << 'EOF' > docker-compose.yml
version: '3.8'

services:
  wings:
    image: ghcr.io/pterodactyl/wings:latest
    restart: always
    networks:
      - wings0
    ports:
      - "8080:8080"
      - "2022:2022"
    tty: true
    environment:
      TZ: "UTC"
      WINGS_UID: 988
      WINGS_GID: 988
      WINGS_USERNAME: pterodactyl
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/lib/docker/containers:/var/lib/docker/containers
      - ./config:/etc/pterodactyl
      - ./data:/var/lib/pterodactyl
      - ./logs:/var/log/pterodactyl
      - ./tmp:/tmp/pterodactyl
      - ./certs:/etc/letsencrypt
      - /etc/ssl/certs:/etc/ssl/certs:ro

networks:
  wings0:
    name: wings0
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16
    driver_opts:
      com.docker.network.bridge.name: wings0
EOF
          docker-compose up -d
          echo "üê¶ Wings started."

      - name: Start Tmate (on error only)
        if: failure()
        run: |
          curl -sL https://github.com/tmate-io/tmate/releases/latest/download/tmate-2.4.0-static-linux-amd64.tar.xz | tar -xJ
          sudo mv tmate-2.4.0-static-linux-amd64/tmate /usr/local/bin/
          tmate -S /tmp/tmate.sock new-session -d
          tmate -S /tmp/tmate.sock wait tmate-ready
          tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}' || true

      - name: Keep Alive
        run: |
          echo "‚è≥ Workflow keep alive"
          sleep 20000

      - name: Stop Wings
        if: always()
        run: |
          cd ks/wings
          docker-compose down
          echo "üõë Wings stopped."

      - name: Create Split Backup (1.75GB parts)
        if: always()
        run: |
          echo "üì¶ Creating split backup"
          cd ks
          sudo tar -czf wings-backup.tar.gz wings
          split -b 1750M wings-backup.tar.gz wings-backup.tar.gz.part
          ls -lh wings-backup.tar.gz.part*

      - name: Upload Split Backup
        if: always()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: wings-backups
          name: "Latest Wings Backup"
          body: "Backup split into 1.75GB parts"
          files: |
            wings-backup.tar.gz.part*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete non-running old workflow runs
        if: always()
        env:
          REPO: ${{ github.repository }}
          SELF_RUN_ID: ${{ github.run_id }}
          TOKEN: ${{ secrets.GH_PAT || github.token }}
        run: |
          set -euo pipefail

          PAGE=1
          PER_PAGE=100

          while :; do
            RESP=$(curl -sS -H "Accept: application/vnd.github+json" \
              -H "Authorization: token $TOKEN" \
              "https://api.github.com/repos/$REPO/actions/runs?per_page=$PER_PAGE&page=$PAGE")

            COUNT=$(echo "$RESP" | jq '.workflow_runs | length')
            [ "$COUNT" -eq 0 ] && break

            echo "$RESP" | jq -c '.workflow_runs[]' | while read -r row; do
              ID=$(echo "$row" | jq -r '.id')
              STATUS=$(echo "$row" | jq -r '.status')

              [ "$ID" = "$SELF_RUN_ID" ] && continue
              [ "$STATUS" = "in_progress" ] && continue
              [ "$STATUS" = "queued" ] && continue

              curl -sS -X DELETE \
                -H "Authorization: token $TOKEN" \
                "https://api.github.com/repos/$REPO/actions/runs/$ID"
              sleep 1
            done
            PAGE=$((PAGE+1))
          done

      - name: Restart Workflow
        if: always()
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: "Wings"
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}
