name: Wings

on:
  workflow_dispatch:

permissions:
  actions: write
  contents: write

concurrency:
  group: pterodactyl
  cancel-in-progress: true

jobs:
  us-node-1:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install Docker Compose
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version

      - name: Download latest backup from Releases
        continue-on-error: true
        uses: robinraju/release-downloader@v1.11
        with:
          tag: wings-backups
          fileName: "us-node-1-backup.tar.gz"
          out-file-path: "."

      - name: Restore backup
        run: |
          sudo mkdir -p ks/pterodactyl/wings
          cd ks
          if [ -f "${GITHUB_WORKSPACE}/us-node-1-backup.tar.gz" ]; then
            echo "ðŸ”„ Found backup"
            sudo rm -rf pterodactyl
            sudo rm -rf /var/lib/pterodactyl
            sudo rm -rf /var/lib/docker
            sudo tar -xzvf "${GITHUB_WORKSPACE}/us-node-1-backup.tar.gz" -C /
            echo "âœ… Backup restored"
          else
            echo "âš ï¸ No backup found, creating fresh directory"
          fi

      - name: Cloudflare Tunnel
        run: |
          sudo curl -L "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64" -o /usr/local/bin/cloudflared
          sudo chmod +x /usr/local/bin/cloudflared
          sudo cloudflared service install eyJhIjoiZTJkZjY3MDI5ZWZlZTBmY2JhM2ExMjNjN2VmNTcxNTAiLCJ0IjoiZjg0NThiMjEtM2IwOS00ZmY0LThiNDMtMjcwMmEzNjQ1NmU4IiwicyI6Ik9ERXpOVGhtT0RndE9UQXhOUzAwTURZNExXSTVOamN0WXpNNU9UQXpOVFE0WkdFMCJ9

      - name: Config
        run: |
          cd ks/pterodactyl/wings
          sudo mkdir -p config
          cd config
          sudo wget https://raw.githubusercontent.com/kswebsite/wings-1/refs/heads/main/config/us-node-1.yml -O config.yml
      
      - name: Start Panel
        run: |
          cd ks/pterodactyl/wings
          sudo rm docker-compose.yml || true
          sudo wget https://raw.githubusercontent.com/kswebsite/wings-1/refs/heads/main/docker-compose.yml
          docker-compose up -d
          echo "âœ… Wings started."

      - name: Start Tmate (Only on error)
        if: always()
        run: |
          curl -sL https://github.com/tmate-io/tmate/releases/latest/download/tmate-2.4.0-static-linux-amd64.tar.xz | tar -xJ
          sudo mv tmate-2.4.0-static-linux-amd64/tmate /usr/local/bin/ || true
          tmate -S /tmp/tmate.sock new-session -d
          tmate -S /tmp/tmate.sock wait tmate-ready
          tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}' || true
          
      - name: Keep Alive
        run: |
          echo "â³ Keeping workflow alive"
          sleep 20000

      - name: Error Delay
        if: failure()
        run: |
          echo "âŒ Error detected. Waiting before shutdown..."
          sleep 500

      - name: Stop Wings
        if: always()
        run: |
          cd ks/pterodactyl/wings
          docker-compose down
          echo "âœ… Wings stopped."

      - name: Create Backup
        if: always()
        run: |
          echo "ðŸ“¦ Creating backup"
          cd ks/pterodactyl/wings
          sudo tar -czvf us-node-1-backup.tar.gz /var/lib/pterodactyl /var/lib/docker /etc/ssl/certs
          
      - name: Upload Backup
        if: always()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: wings-backups
          name: "Latest Pterodactyl Backup"
          body: "Full backup of ks/pterodactyl"
          files: us-node-1-backup.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete ONLY non-running workflow runs
        if: always()
        env:
          REPO: ${{ github.repository }}
          SELF_RUN_ID: ${{ github.run_id }}
          # Use your PAT stored as GH_PAT. Create it with repo + workflow scopes.
          # If GH_PAT is missing the script falls back to GITHUB_TOKEN, but that may still fail.
          TOKEN: ${{ secrets.GH_PAT || github.token }}
        run: |
          set -euo pipefail

          if [ -z "$TOKEN" ]; then
            echo "ERROR: No token provided. Set secrets.GH_PAT or rely on github.token."
            exit 1
          fi

          echo "Using token from secrets (hidden). This workflow ID = $SELF_RUN_ID"
          PAGE=1
          PER_PAGE=100

          while :; do
            echo "--- fetching page $PAGE"
            RESP=$(curl -sS -H "Accept: application/vnd.github+json" \
              -H "Authorization: token $TOKEN" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/$REPO/actions/runs?per_page=$PER_PAGE&page=$PAGE")

            # if empty or no workflow_runs, break
            COUNT=$(echo "$RESP" | jq '.workflow_runs | length')
            if [ "$COUNT" -eq 0 ]; then
              echo "No more runs on page $PAGE â€” exiting."
              break
            fi

            echo "Found $COUNT runs on page $PAGE"

            echo "$RESP" | jq -c '.workflow_runs[] | {id: .id, status: .status, name: .name}' | while read -r row; do
              ID=$(echo "$row" | jq -r '.id')
              STATUS=$(echo "$row" | jq -r '.status')
              NAME=$(echo "$row" | jq -r '.name')

              # skip current run and active runs
              if [ "$ID" = "$SELF_RUN_ID" ]; then
                echo "Skipping self run $ID ($NAME)"
                continue
              fi
              if [ "$STATUS" = "in_progress" ] || [ "$STATUS" = "queued" ]; then
                echo "Skipping active run $ID (status: $STATUS)"
                continue
              fi

              echo "Attempting to delete run $ID (status: $STATUS, name: $NAME)..."

              HTTP=$(curl -sS -o /dev/stderr -w "%{http_code}" -X DELETE \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: token $TOKEN" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "https://api.github.com/repos/$REPO/actions/runs/$ID" 2> /tmp/delete_resp)

              # print any message returned
              if [ -s /tmp/delete_resp ]; then
                echo "API response: $(cat /tmp/delete_resp)"
              fi

              if [ "$HTTP" = "204" ] || [ "$HTTP" = "202" ] || [ "$HTTP" = "200" ]; then
                echo "Deleted run $ID successfully (HTTP $HTTP)"
              else
                echo "Failed to delete run $ID (HTTP $HTTP)."
                # Common reason: 403 Resource not accessible by integration (token lacks permission)
                if [ "$HTTP" = "403" ]; then
                  echo "403 error â€” likely the token used does not have permission to delete this run."
                  echo "Use a PAT with 'repo' and 'workflow' scopes stored in secrets.GH_PAT, or ensure GITHUB_TOKEN has actions: write and org policies allow delete from actions."
                fi
              fi

              # small sleep to avoid hitting secondary rate limits
              sleep 1
            done

            # next page
            PAGE=$((PAGE+1))
            # safety â€” if you want to stop after N pages, add a guard here
          done

          echo "Cleanup complete."
          
      - name: Restart Workflow
        if: always()
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: "Wings"
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}
          
